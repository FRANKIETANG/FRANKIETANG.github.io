---
title: 堆叠上下文
date: 2018-02-09 18:20:10
tags:
- CSS
categories:
- CSS
description: CSS 世界里的“排队规则”。
---

# 堆叠上下文

http://www.zhangxinxu.com/wordpress/2016/01/understand-css-stacking-context-order-z-index/

## 堆叠顺序

举个例子，先看看下面这个代码。

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <style>
    .parent{
      width: 200px;
      height: 200px;
      border: 10px solid rgba(255,1,1,0.5);
      padding: 15px;
      margin: 15px;
      background: yellow;
      text-indent: -20px;
      color: blue;
    }
    .child{
      height: 50px;
      background: purple;
      margin-top: -20px;
      color: green;
    }
    .float{
      width: 30px;
      height: 70px;
      background: orange;
      float: left;
      color: red;
    }
    .relative{
      width: 100px;
      height: 100px;
      background: teal;
      position: relative;
      margin-top: -10px;
      z-index: 1;
    }
    .relative2{
      width: 100px;
      height: 100px;
      background: olive;
      position: relative;
      margin-top: -50px;
    }
    .relative3{
      width: 100px;
      height: 100px;
      background: aqua;
      position: relative;
      margin-top: 20px;
      z-index: -1;
    }    
  </style>
</head>
<body>
  <div class="parent">
    ████
    <div class="float">
      ████
    </div>
    <div class="child">
      ████
      ████
      ████
      ████
    </div>
    <div class="relative"></div>
  </div>
  <div class="parent">
    <div class="relative"></div>
    <div class="relative2"></div>
    <div class="relative3"></div>
  </div>  
</body>
</html>
```

变成下面这张图。

![](https://i.loli.net/2018/01/30/5a707eaa4f0d7.png)

顺序如下

1. 负 z-index
2. background
3. border
4. div / 块级元素
5. 浮动元素
6. 文字 / 内联 （浮动元素文字 < 父元素文字 < 子元素文字）
7. position （同时 z-index 是 0）
8. 正 z-index

![](https://us1.myximage.com/2018/01/30/2b9ea98b8c99f55e454266f352f5c457.png)

**注意**

`z-index` 只能对加了 `position` 的属性生效。

`z-index: auto` 等于 `z-index: 0` 。

不管是 `relative` 还是 `absolute` 他们也是按照 `z-index` 的顺序排序的。

## 堆叠上下文

注意这个例子

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <style>
    .parent{
      width: 200px;
      height: 200px;
      border: 5px solid rgba(255,0,0,1);
      padding: 15px;
      margin: 15px;
      background: #000;
      position: relative;
      z-index: 0; /*注意这里，本来是z-index: auto*/
    }
    .child{
      height: 20px;
      background: purple;
      color: black;
    }
    .float{
      width: 50px;
      height: 30px;
      background: blue;
      float: left;
      color: red;
    }
    .relative{
      width: 100px;
      height: 100px;
      background: orange;
      position: relative;
    }
    .fu{
      width: 100px;
      height: 100px;
      background: green;
      position: relative;
      z-index: -1;
      margin-top: -50px;
    }
  </style>
</head>
<body>
  <div class="parent">
    <span>████</span>
    <div class="child"></div>
    <div class="relative"></div>
    <div class="fu"></div>
    <div class="float"></div>
  </div>
</body>
</html>
```

效果像这样。

![](https://i.loli.net/2018/01/31/5a718377ab86b.png)

绿色方块跑上来了，但是被黄色方块盖住了。

不要橙色方块

```css
.relative{
  width: 100px;
  height: 100px;
  background: orange;
  position: relative;
  display: none;
}
```

发现紫色方块也盖不住。

![](https://i.loli.net/2018/01/31/5a7184694073d.png)

所以说，如果把父级块级元素被定位了，那负 z-index 就会浮上来，但是在子级块级元素的后面。

这，就是堆叠上下文。

**重要！**

> 可以这样理解，background 那个盒子已经成为了一个新的部门，脱离了主部门，所以 background 那个盒子和主盒子不是一个部门，而负 z-index 属于主部门，所以就跟着主部门浮上来了。

这个负 z-index 是有可能会变的

https://developer.mozilla.org/zh-CN/docs/Web/Guide/CSS/Understanding_z_index/The_stacking_context

MDN：

>文档中的层叠上下文由满足以下任意一个条件的元素形成：
>
>- 根元素 (HTML),
>- z-index 值不为 "auto"的 绝对/相对定位，
>- 一个 z-index 值不为 "auto"的 flex 项目 (flex item)，即：父元素 display: flex|inline-flex，
>- [`opacity`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/opacity) 属性值小于 1 的元素（参考 [the specification for opacity](http://www.w3.org/TR/css3-color/#transparency)），
>- [`transform`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/transform) 属性值不为 "none"的元素，
>- [`mix-blend-mode`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/mix-blend-mode) 属性值不为 "normal"的元素，
>- [`filter`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/filter)值不为“none”的元素，
>- [`perspective`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/perspective)值不为“none”的元素，
>- [`isolation`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/isolation) 属性被设置为 "isolate"的元素，
>- `position: fixed`
>- 在 [`will-change`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/will-change) 中指定了任意 CSS 属性，即便你没有直接指定这些属性的值（参考 [这篇文章](http://dev.opera.com/articles/css-will-change-property/)）
>- [`-webkit-overflow-scrolling`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/-webkit-overflow-scrolling) 属性被设置 "touch"的元素

张鑫旭的解释：

>层叠上下文元素有如下特性：
>
>- 层叠上下文的层叠水平要比普通元素高（原因后面会说明）；
>- 层叠上下文可以阻断元素的混合模式（见[此文第二部分说明](http://www.zhangxinxu.com/wordpress/?p=5155)）；
>- 层叠上下文可以嵌套，内部层叠上下文及其所有子元素均受制于外部的层叠上下文。
>- 每个层叠上下文和兄弟元素独立，也就是当进行层叠变化或渲染的时候，只需要考虑后代元素。
>- 每个层叠上下文是自成体系的，当元素发生层叠的时候，整个元素被认为是在父层叠上下文的层叠顺序中。
>
>翻译成真实世界语言就是：
>
>- 当官的比老百姓更有机会面见圣上；
>- 领导下去考察，会被当地官员阻隔只看到繁荣看不到真实民情；
>- 一个家里，爸爸可以当官，孩子也是可以同时当官的。但是，孩子这个官要受爸爸控制。
>- 自己当官，兄弟不占光。有什么福利或者变故只会影响自己的孩子们。
>- 每个当官的都有属于自己的小团体，当家眷管家发生摩擦磕碰的时候（包括和其他官员的家眷管家），都是要优先看当官的也就是主子的脸色。

所以说上面这个现象可以用 MDN 的这句话解释

>z-index 值不为 "auto" 的绝对/相对定位，

MDN 的几句话比较重要，不用记，用问题再查。

再举个几个例子

![](https://i.loli.net/2018/01/31/5a71c042d13c2.png)

> [`opacity`](https://developer.mozilla.org/zh-CN/docs/Web/CSS/opacity) 属性值小于 1 的元素（参考 [the specification for opacity](http://www.w3.org/TR/css3-color/#transparency)）

说白了就是，所见即所得。

## 堆叠上下文对 z-index 的影响

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <style>
    .parent{
      width: 200px;
      height: 200px;
      border: 5px solid rgba(255,0,0,1);
      padding: 15px;
      margin: 15px;
      background: #000;
      position: relative;
      z-index: 1;
    }
    .relative{
      width: 100px;
      height: 100px;
      background: orange;
      position: relative;
      border: 1px solid red;
    }
    .a1,
    .b1{
      background: green;
    }
    .b1{
      background: blue;
      margin-top: -90px;
    }
  </style>
</head>
<body>
  <div class="parent">
    <div class="a relative">a
      <div class="a1">a1</div>
    </div>
    <div class="b relative">b
      <div class="b1">b1</div>
    </div>
  </div>
</body>
</html>
```

![](https://i.loli.net/2018/01/31/5a71c33c19e3d.png)

通过上面 MDN 介绍的堆叠上下文，很轻易的得出。

>根元素 (HTML),

谁后出现，谁盖住谁。

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <style>
    .parent{
      width: 200px;
      height: 200px;
      border: 5px solid rgba(255,0,0,1);
      padding: 15px;
      margin: 15px;
      background: #000;
      position: relative;
      z-index: 1;
    }
    .relative{
      width: 100px;
      height: 100px;
      background: orange;
      position: relative;
      border: 1px solid red;
    }
    
    .a1,
    .b1{
      background: green;
      position: relative;
    }
    .a1{
      z-index: 2;
    }
    .b1{
      background: blue;
      margin-top: -90px;
      z-index: 0;
    }
  </style>
</head>
<body>
  <div class="parent">
    <div class="a relative">a
      <div class="a1">a1</div>
    </div>
    <div class="b relative">b
      <div class="b1">b1</div>
    </div>
  </div>
</body>
</html>
```

但是如果这个基础上加上 z-index 就会变成这样。

![](https://i.loli.net/2018/01/31/5a71c6c3ced23.png)

这个还是很好理解的，但是如果在 a1 和 b1 加上 `z-index: 1` ，又会变成 HTML 产生的堆叠上下文。

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <style>
    .parent{
      width: 200px;
      height: 200px;
      border: 5px solid rgba(255,0,0,1);
      padding: 15px;
      margin: 15px;
      background: #000;
      position: relative;
      z-index: 1;
    }
    .relative{
      width: 100px;
      height: 100px;
      background: orange;
      position: relative;
      border: 1px solid red;
    }
    
    .a1,
    .b1{
      background: green;
      position: relative;
    }
    .a1{
      z-index: 2;
    }
    .b1{
      background: blue;
      margin-top: -90px;
      z-index: 0;
    }

    .a{
      position: relative;
      z-index: 1;
    }
    
    .b{
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div class="parent">
    <div class="a relative">a
      <div class="a1">a1</div>
    </div>
    <div class="b relative">b
      <div class="b1">b1</div>
    </div>
  </div>
</body>
</html>
```

![](https://i.loli.net/2018/01/31/5a71c33c19e3d.png)

b1 和 a1 是平级的，但是 b1 干过了 a1 。