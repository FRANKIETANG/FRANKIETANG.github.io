<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 摸到 React 的门把手 (3) · 付林恒的博客</title><meta name="description" content="摸到 React 的门把手 (3) - Frankie Tang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="付林恒的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/frankietang" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">摸到 React 的门把手 (3)</h1><div class="post-info">Oct 14, 2017</div><div class="post-content"><h1 id="摸到-React-的门把手-3"><a href="#摸到-React-的门把手-3" class="headerlink" title="摸到 React 的门把手 (3)"></a>摸到 React 的门把手 (3)</h1><p>经过了上几篇文章 <a href="https://frankietang.github.io/2017/08/18/%E6%91%B8%E5%88%B0%20React%20%E7%9A%84%E9%97%A8%E6%8A%8A%E6%89%8B/" target="_blank" rel="external">摸到 React 的门把手</a> <a href="https://frankietang.github.io/2017/08/20/%E6%91%B8%E5%88%B0%20React%20%E7%9A%84%E9%97%A8%E6%8A%8A%E6%89%8B%20(2" target="_blank" rel="external">摸到 React 的门把手 (2)</a>/) 的踩坑，我们估计很快就可以摸到门把手了。</p>
<h2 id="关于-JSX"><a href="#关于-JSX" class="headerlink" title="关于 JSX"></a>关于 JSX</h2><p>实际上 JSX 并不是 JavaScript 和 HTML 的结合，而是和 XML 的结合，就像这样。<a href="https://babeljs.io/repl/" target="_blank" rel="external">https://babeljs.io/repl/</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-264608323011334e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><a href="https://facebook.github.io/react/docs/introducing-jsx.html" target="_blank" rel="external">Introducing - JSX</a></p>
<h2 id="关于-React-的虚拟-DOM"><a href="#关于-React-的虚拟-DOM" class="headerlink" title="关于 React 的虚拟 DOM"></a>关于 React 的虚拟 DOM</h2><blockquote>
<p>你用这些 XML 写出来的标签，都不会出现在页面里，只会出现在内存里。React 会使用虚拟 DOM 计算出真正的页面结构，然后再更新到页面中（真正的 DOM 操作）。</p>
<p>让 JS 操作内存肯定比操作 DOM 要快很多。</p>
</blockquote>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-04a725ede551ad1e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="."></p>
<p>看看这一段代码：</p>
<ul>
<li>用 XML 语法声明一个 h1</li>
<li>babel 将 h1 转为 React Element（虚拟元素）</li>
<li>React 将虚拟元素转化为真正的 DOM，插入到 #root 里。</li>
</ul>
<h2 id="按需更新"><a href="#按需更新" class="headerlink" title="按需更新"></a>按需更新</h2><blockquote>
<p>With our knowledge so far, the only way to update the UI is to create a new element, and pass it to <code>ReactDOM.render()</code>.</p>
</blockquote>
<p>所以说更新一个元素的唯一方法就是新的元素</p>
<p>我们改一下 index.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tick</span>(<span class="params"></span>) </span>&#123;</span>
<span class="line">  <span class="keyword">const</span> element = (</span>
<span class="line">    &lt;div&gt;</span>
<span class="line">      &lt;h1&gt;Hello, world!<span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span>
<span class="line">      &lt;h2&gt;It is &#123;<span class="keyword">new</span> <span class="built_in">Date</span>().toLocaleTimeString()&#125;.&lt;<span class="regexp">/h2&gt;</span></span>
<span class="line"><span class="regexp">    &lt;/</span>div&gt;</span>
<span class="line">  );</span>
<span class="line">  ReactDOM.render(</span>
<span class="line">    element,</span>
<span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span>
<span class="line">  );</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">setInterval(tick, <span class="number">1000</span>);</span>
</pre></td></tr></table></figure>
<p>这个示例通过 <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowTimers/setInterval" target="_blank" rel="external"><code>setInterval()</code></a> 方法，每秒钟调用一次 <code>ReactDOM.render()</code>.</p>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span>
<span class="line">    render() &#123;</span>
<span class="line">        <span class="keyword">return</span> &lt;h1&gt;<span class="type">Component</span>&lt;/h1&gt;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="type">ReactDOM</span>.render(</span>
<span class="line">    &lt;<span class="type">Welcome</span>/&gt;,</span>
<span class="line">    document.getElementById(<span class="symbol">'roo</span>t')</span>
<span class="line">)</span>
</pre></td></tr></table></figure>
<p>这样我们就造了一个 <code>&lt;Welcome/&gt;</code> 的组件</p>
<p><code>extends React.Component</code> 不能删掉。</p>
<h2 id="组件成为一个单独代码"><a href="#组件成为一个单独代码" class="headerlink" title="组件成为一个单独代码"></a>组件成为一个单独代码</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//src/Welcome.js</span></span>
<span class="line"><span class="keyword">import</span> <span class="type">React</span> from <span class="symbol">'reac</span>t'</span>
<span class="line"></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span>
<span class="line">    render() &#123;</span>
<span class="line">        <span class="keyword">return</span> &lt;h1&gt;<span class="type">Component</span>&lt;/h1&gt;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">export <span class="keyword">default</span> <span class="type">Welcome</span></span>
</pre></td></tr></table></figure>
<p><code>import React from &#39;react&#39;</code> 这个是引用 React ，不写这一句就在这个组件代码里就用不了 <code>React.Component</code></p>
<p><code>export</code> 和 <code>export default</code> 作用是导出常量/函数/文件/模块 这些</p>
<p><code>export</code> 和 <code>import</code> 可以有多个，<code>export default</code> 只能有一个</p>
<p><code>export</code> 导出导入的时候要加 {}，<code>export default</code> 则不需要</p>
<p><a href="http://www.jianshu.com/p/edaf43e9384f" target="_blank" rel="external">ES6：export default 和 export 区别</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//src/index.js</span></span>
<span class="line"><span class="keyword">import</span> Welcome <span class="keyword">from</span> <span class="string">'./Welcome'</span></span>
<span class="line"></span>
<span class="line">ReactDOM.render(</span>
<span class="line">  &lt;Welcome/&gt;,</span>
<span class="line">  <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span>
<span class="line">)</span>
</pre></td></tr></table></figure>
<h2 id="props"><a href="#props" class="headerlink" title="props"></a>props</h2><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//src/Welcome.js</span></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span>
<span class="line">    render() &#123;</span>
<span class="line">        <span class="keyword">return</span> &lt;h1&gt;<span class="type">I</span> am &#123;<span class="keyword">this</span>.props.name&#125;&lt;/h1&gt;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line"><span class="comment">//其中 class Welcome 变成 funciton Welcome</span></span>
</pre></td></tr></table></figure>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line">ReactDOM.render(</span>
<span class="line">    &lt;Welcome name=<span class="string">"tangkalun"</span>/&gt;,</span>
<span class="line">    <span class="built_in">document</span>.getElementById(<span class="string">'root'</span>)</span>
<span class="line">)</span>
</pre></td></tr></table></figure>
<h2 id="state"><a href="#state" class="headerlink" title="state"></a>state</h2><blockquote>
<p>组件不能改变得到的 props，那么组件中可以变的东西放在哪呢？答案是 state（函数形式的组件不支持 state）。</p>
</blockquote>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//src/Welcome.js</span></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Welcome</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span>
<span class="line">    constructor(props)&#123;</span>
<span class="line">        <span class="keyword">super</span>(props)</span>
<span class="line">        <span class="keyword">this</span>.state = &#123;</span>
<span class="line">            date: <span class="keyword">new</span> <span class="type">Date</span>()</span>
<span class="line">        &#125;</span>
<span class="line">    &#125;</span>
<span class="line">    render() &#123;</span>
<span class="line">        <span class="keyword">return</span> (</span>
<span class="line">            &lt;div&gt;</span>
<span class="line">                &lt;h1&gt;<span class="type">I</span> am &#123;<span class="keyword">this</span>.props.name&#125;&lt;/h1&gt;</span>
<span class="line">                &lt;h2&gt;&#123;<span class="keyword">this</span>.state.date.toString()&#125;.&lt;/h2&gt;                </span>
<span class="line">            &lt;/div&gt;</span>
<span class="line">        )</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="改变-state"><a href="#改变-state" class="headerlink" title="改变 state"></a>改变 state</h2><p>这里我们可以用 <code>setState()</code> 来改变 state。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//在 constructor 里加</span></span>
<span class="line">setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span>
<span class="line">  <span class="keyword">this</span>.state = &#123;</span>
<span class="line">    date: <span class="keyword">new</span> <span class="built_in">Date</span>()</span>
<span class="line">  &#125;</span>
<span class="line">&#125;)</span>
</pre></td></tr></table></figure>
<p>这上面的代码是有问题的，实际上还要 <code>.bind(this)</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line">setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span>
<span class="line">  <span class="keyword">this</span>.setState(&#123;</span>
<span class="line">    date: <span class="keyword">new</span> <span class="built_in">Date</span>()</span>
<span class="line">  &#125;)</span>
<span class="line">&#125;.bind(<span class="keyword">this</span>))</span>
</pre></td></tr></table></figure>
<blockquote>
<p>The callback is made in a different context. You need to <code>bind</code> to <code>this</code> in order to have access inside the callback</p>
</blockquote>
<p><a href="https://stackoverflow.com/questions/31045716/react-this-setstate-is-not-a-function" target="_blank" rel="external">React this.setState is not a function</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/25954470" target="_blank" rel="external">setState：这个API设计到底怎么样</a></p>
<p>我讨厌 setState 这个 API</p>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p><a href="https://facebook.github.io/react/docs/react-component.html#the-component-lifecycle" target="_blank" rel="external">The Component Lifecycle</a></p>
<p>React 的生命周期包括三个阶段：mount（挂载）、update（更新）和 unmount（移除）</p>
<h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h3><blockquote>
<p>mount 就是第一次让组件出现在页面中的过程。这个过程的关键就是 render 方法。React 会将 render 的返回值（一般是虚拟 DOM，也可以是 DOM 或者 null）插入到页面中。</p>
<p>这个过程会暴露几个钩子（hook）方便你往里面加代码：</p>
<ul>
<li><code>constructor()</code> 初始化 props 和 state</li>
<li><code>componentWillMount()</code> 我要插入了</li>
<li><code>render()</code> 将 render 里的 return 的内容插入到页面中</li>
<li><code>componentDidMount()</code> 插进去后该做点什么吗？</li>
</ul>
</blockquote>
<p>commit: <a href="https://github.com/FRANKIETANG/react-demo/commit/cad040489620cf5b4f7e02a571cb2e3c06803932" target="_blank" rel="external">钩子</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-c31f16851c918ba5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><blockquote>
<p>mount 之后，如果数据有任何变动，就会来到 update 过程，这个过程有 5 个钩子：</p>
<ul>
<li><code>componentWillReceiveProps(nextProps)</code> - 我要读取 props 啦！</li>
<li><code>shouldComponentUpdate(nextProps, nextState)</code> - 请问要不要更新组件？true / false</li>
<li><code>componentWillUpdate()</code> - 我要更新组件啦！</li>
<li><code>render()</code> - 更新！</li>
<li><code>componentDidUpdate()</code> - 更新完毕啦！</li>
</ul>
</blockquote>
<h3 id="unmount"><a href="#unmount" class="headerlink" title="unmount"></a>unmount</h3><blockquote>
<p>当一个组件将要从页面中移除时，会进入 unmount 过程，这个过程就一个钩子：</p>
<ul>
<li>componentWillUnmount() - 我要死啦！</li>
</ul>
</blockquote>
<h2 id="setState-应该放在哪？"><a href="#setState-应该放在哪？" class="headerlink" title="setState 应该放在哪？"></a>setState 应该放在哪？</h2><p>commit: <a href="https://github.com/FRANKIETANG/react-demo/commit/3b2061343d754f2975356ef4502d445e943eef5a" target="_blank" rel="external">哪些钩子里面可以加 setState</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-6dc701032129deb9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这里面有三个错误</p>
<p>第一个错误说明不能在 constructor 里面 setState</p>
<p>第二个错误说明不能在 render 里面 setState</p>
<p>第三个错误说明 Welcome.shouldComponentUpdate 必须返回 boolean value，那我们改改</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-ace3aae6e3f84a99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>好吧错误都是 render 的，那就都删掉吧。</p>
<p>还是会有 bug 原因是在 componentWillUpdate 和 componentDidUpdate 里 setState 了，因为每次 setState 都会触发这两个钩子，而这两个钩子却又触发了 setState。</p>
<p>所以只能在这几个钩子里 setState：</p>
<ul>
<li><code>componentWillMount</code></li>
<li><code>componentDidMount</code></li>
<li><code>componentWillReceiveProps</code></li>
<li><code>componentDidUpdate</code></li>
</ul>
<h2 id="看看成果"><a href="#看看成果" class="headerlink" title="看看成果"></a><a href="https://github.com/FRANKIETANG/react-demo" target="_blank" rel="external">看看成果</a></h2></div></article></div></main><footer><div class="paginator"><a href="/2017/10/14/摸到 React 的门把手 (4)/" class="prev">PREV</a><a href="/2017/10/14/摸到 React 的门把手 (2)/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2017/10/14/摸到 React 的门把手 (3)/';
var disqus_title = '摸到 React 的门把手 (3)';
var disqus_url = 'http://yoursite.com/2017/10/14/摸到 React 的门把手 (3)/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Frankie Tang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>