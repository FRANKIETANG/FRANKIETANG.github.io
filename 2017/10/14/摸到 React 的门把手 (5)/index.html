<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 摸到 React 的门把手 (5) · 付林恒的博客</title><meta name="description" content="摸到 React 的门把手 (5) - Frankie Tang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="付林恒的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/frankietang" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">摸到 React 的门把手 (5)</h1><div class="post-info">Oct 14, 2017</div><div class="post-content"><h1 id="摸到-React-的门把手-5"><a href="#摸到-React-的门把手-5" class="headerlink" title="摸到 React 的门把手 (5)"></a>摸到 React 的门把手 (5)</h1><p>这次我们就来天我们上一次挖的深坑 <a href="https://frankietang.github.io/2017/08/22/%E6%91%B8%E5%88%B0%20React%20%E7%9A%84%E9%97%A8%E6%8A%8A%E6%89%8B%20(4" target="_blank" rel="external">摸到 React 的门把手 (4)</a>/) ，慢慢填，不用急。干那么快干嘛，要好好享受过程。体验学到知识的快感。</p>
<h2 id="localStorage"><a href="#localStorage" class="headerlink" title="localStorage"></a>localStorage</h2><p>看名字就感觉应该是一个保存本地数据的玩意对吧（我猜的）<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage" target="_blank" rel="external">loocalStorage</a></p>
<p>我们用这个方法就可以保存数据而不会一刷新就会初始化了</p>
<ul>
<li>用户提交数据的时候，将所有的 todo 字符串的形式保存在 localStorage</li>
<li>重新打开页面的时候，将 localStorage 里面的字符串变为对象赋值给 todoList</li>
</ul>
<p>封装 localStorage 封装成两个函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params">key,value</span>)</span>&#123;</span>
<span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.localStorage.setItem(key,</span>
<span class="line">        <span class="built_in">JSON</span>.stringify(value))</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params">key</span>)</span>&#123;</span>
<span class="line">    <span class="keyword">return</span> <span class="built_in">JSON</span>.parse(<span class="built_in">window</span>.localStorage.getItem(key))</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>load 和 save 的调用</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// load</span></span>
<span class="line"><span class="selector-tag">localStore</span><span class="selector-class">.load</span>(<span class="string">'todoList'</span>) || <span class="selector-attr">[]</span></span>
<span class="line"><span class="comment">// save</span></span>
<span class="line"><span class="selector-tag">localStore</span><span class="selector-class">.save</span>(<span class="string">'todoList'</span>,this.state.todoList)</span>
</pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-7c1b95c23aa12525.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><code>||</code> 居然还有这种操作？可以用来定义默认参数？</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-0dcd24f922e4a0aa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>不过 ES6 有了新的默认参数用法</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-48b523717d27a58e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>好了这里就不展开了。</p>
<h2 id="优化代码"><a href="#优化代码" class="headerlink" title="优化代码"></a>优化代码</h2><p>之前在每个 setState 之后会运行一次 save，但是我们知道 componentDidUpdate 会在组件更新之后调用，相当于 “组件更新” 等价于 “数据更新”</p>
<p>利用 componentDidUpdate 封装代码。</p>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>其实我们不需要服务器，用 LeanCloud 就可以了。</p>
<p>点击创建应用</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-f47971710bf3edd6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p><a href="https://leancloud.cn/docs/leanstorage_guide-js.html" target="_blank" rel="external">看文档</a></p>
<p><a href="https://leancloud.cn/docs/sdk_setup-js.html" target="_blank" rel="external">JavaScript SDK 安装指南</a></p>
<p>安装</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">$ sudo npm <span class="keyword">install</span> leancloud-<span class="keyword">storage</span> <span class="comment">--save</span></span>
</pre></td></tr></table></figure>
<p>复制这一段代码到我们的App.js</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-49cd74d87191419f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">ping api<span class="selector-class">.leancloud</span><span class="selector-class">.cn</span></span>
</pre></td></tr></table></figure>
<p>验证结果如下则正常</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-e10c06115a5054f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>然后我们测试下面这一段代码。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-d0ceaa7fa89d6cc4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>OK 了</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-4797976d0ab6e532.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>然后我们就继续把 LeanCloud 的对象和用户的开发文档看一遍，就可以继续写代码了。</p>
<h2 id="继续撸代码"><a href="#继续撸代码" class="headerlink" title="继续撸代码"></a>继续撸代码</h2><p>先把我们上面的 localStore 给删掉</p>
<p>然后做出一个登录框</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-c5799a036bc6459c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>还要让它变成一个选项卡来回切换</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-caefa908df34d17f.gif?imageMogr2/auto-orient/strip" alt=""></p>
<p>把 form 表单的 input 和 formData 绑定用下面这种方法是不行的</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line">changeUsername(e)&#123;</span>
<span class="line">    this.<span class="keyword">state</span>.formData.username = e.target.value</span>
<span class="line">    this.<span class="built_in">set</span>State(this.<span class="keyword">state</span>)</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>其实是不行的，原因看 <a href="https://stackoverflow.com/questions/37755997/why-cant-i-directly-modify-a-components-state-really" target="_blank" rel="external">Why can’t I directly modify a component’s state, really?</a> 里面 <a href="https://stackoverflow.com/users/4945468/pranesh-ravi" target="_blank" rel="external">Pranesh Ravi</a> 的答案。</p>
<blockquote>
<p>Just a reminder: most basic methods for cloning in JS (<code>slice</code>, ES6 destructuring, etc.) are shallow. If you have a nested array or nested objects you’ll need to look at other methods of deep copying, e.g. <code>JSON.parse(JSON.stringify(obj))</code> (though this particular method won’t work if your object has circular references). </p>
</blockquote>
<p>因为对象是嵌套的，所以要用深拷贝的方法。</p>
<p>点击注册后使用 LeanCloud API 来注册</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-0359d75695fc17ef.gif?imageMogr2/auto-orient/strip" alt=""></p>
<p>这样数据就能来到了</p>
<p>来到后还要把它记住并显示出来</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-a186a02fe0ba8bc2.gif?imageMogr2/auto-orient/strip" alt=""></p>
<p>实现注册成功关闭窗口</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-d801a196febd2d97.gif?imageMogr2/auto-orient/strip" alt=""></p>
<p>用户进入页面时读取上次登录的 user</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-bbc5b207c51506ce.gif?imageMogr2/auto-orient/strip" alt=""></p>
<p>做出可以登出的功能</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-963e5edeb970c9f1.gif?imageMogr2/auto-orient/strip" alt=""></p>
<p>完成登录功能</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3191557-10f8da0986e07f6b.gif?imageMogr2/auto-orient/strip" alt=""></p>
<p>代码：</p>
<ul>
<li><a href="https://github.com/FRANKIETANG/banana-todolist/commits/master" target="_blank" rel="external">LeanCloud</a></li>
<li><a href="https://github.com/FRANKIETANG/react-todo-list/commits/master" target="_blank" rel="external">localStore</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2017/10/14/摸到 React 的门把手 (6)/" class="prev">PREV</a><a href="/2017/10/14/摸到 React 的门把手 (4)/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2017/10/14/摸到 React 的门把手 (5)/';
var disqus_title = '摸到 React 的门把手 (5)';
var disqus_url = 'http://yoursite.com/2017/10/14/摸到 React 的门把手 (5)/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2017 <a href="http://yoursite.com">Frankie Tang</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>